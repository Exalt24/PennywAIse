{% load static %}

<section id="dashboard" class="page-content" role="main" aria-label="Dashboard">


  {% with section_title="Dashboard"%}
    {% include "main/subheader.html" %}
  {% endwith %}
  
    <section id="overview" class="overview" role="region" aria-label="Overview cards">
      <article class="card" role="region" aria-label="Total Income: ₱{{ income_total|floatformat:2 }} this month">
        <h3 class="title">Total Income</h3>
        <p class="value">₱{{ income_total|floatformat:2 }}</p>
        <p class="meta">This month</p>
        <h3 class="title">Income vs Last Month</h3>
        <p class="value">
          {% if income_pct_change %}
            <p class="value {% if income_pct_change > 0 %}text-green-600{% else %}text-red-600{% endif %}">
              {{ income_pct_change|floatformat:1 }}%
            </p>
          {% else %}
            <p class="value text-gray-500">N/A</p>
          {% endif %}
        </p>

        <p class="meta">₱{{ income_total|floatformat:2 }} - ₱{{ last_income_total|floatformat:2 }}</p>
        <h3 class="title">Largest Income</h3>
        {% if largest_income %}
          <p class="value">₱{{ largest_income.amount|floatformat:2 }}</p>
          <p class="meta">{{ largest_income.title }} on {{ largest_income.date }}</p>
        {% else %}
          <p class="value text-gray-500">—</p>
        {% endif %}
      </article>
      <article class="card" role="region" aria-label="Total Expenses: ₱{{ expense_total|floatformat:2 }} this month">
        <h3 class="title">Total Expenses</h3>
        <p class="value">₱{{ expense_total|floatformat:2 }}</p>
        <p class="meta">This month</p>
        <h3 class="title">Expenses vs Last Month</h3>
        <p class="value">
          {% if expense_pct_change %}
            <p class="value {% if expense_pct_change > 0 %}text-green-600{% else %}text-red-600{% endif %}">
              {{ expense_pct_change|floatformat:1 }}%
            </p>
          {% else %}
            <p class="value text-gray-500">N/A</p>
          {% endif %}
        </p>
        <p class="meta">₱{{ expense_total|floatformat:2 }} - ₱{{ last_expense_total|floatformat:2 }}</p>
        <h3 class="title">Largest Expense</h3>
        {% if largest_expense %}
          <p class="value">₱{{ largest_expense.amount|floatformat:2 }}</p>
          <p class="meta">{{ largest_expense.title }} on {{ largest_expense.date }}</p>
        {% else %}
          <p class="value text-gray-500">—</p>
        {% endif %}
      </article>
      <article class="card" role="region" aria-label="Net Balance: {% if net_balance > 0 %}+₱{{ net_balance_abs|floatformat:2 }}{% elif net_balance < 0 %}−₱{{ net_balance_abs|floatformat:2 }}{% else %}₱0.00{% endif %}">
        <h3 class="title">Net Balance</h3>
        <p
          class="value {% if net_balance > 0 %}text-green-600{% elif net_balance < 0 %}text-red-600{% endif %}"
        >
          {% if net_balance > 0 %}
            +₱{{ net_balance_abs|floatformat:2 }}
          {% elif net_balance < 0 %}
            −₱{{ net_balance_abs|floatformat:2 }}
          {% else %}
            ₱0.00
          {% endif %}
        </p>
        <p class="meta">Income − Expenses</p>
      </article>
      <article class="card" role="region" aria-label="Transactions: {{ transaction_count }} entries this month">
        <h3 class="title">Transactions</h3>
        <p class="value">{{ transaction_count }}</p>
        <p class="meta">Entries this month</p>
      </article>
    </section>

    <section id="insights" class="overview mt-6" role="region" aria-label="Quick Insights">
      <article class="card" role="region" aria-label="Monthly Budget">
        <h3 class="title">Monthly Budget</h3>
        {% if total_budget is not None %}
          <p class="value">
            ₱{{ total_budget|floatformat:2 }}
            <span class="{% if over_budget %}text-red-600{% else %}text-green-600{% endif %}">
              ({% if over_budget %}Over by ₱{{ total_remaining|floatformat:2 }}{% else %}Remaining ₱{{ total_remaining|floatformat:2 }}{% endif %})
            </span>
          </p>
        {% else %}
          <p class="value text-gray-500">Not set</p>
        {% endif %}
        <p class="meta">Total budget</p>
      </article>
      <article class="card">
        <h3 class="title">Top 3 Categories</h3>
        <ul class="space-y-1">
          {% for cat in top_categories_summary %}
            <li class="flex justify-between">
              <span>{{ cat.name }}</span>
              <span class="text-red-600">₱{{ cat.expense|floatformat:2 }}</span>
            </li>
          {% endfor %}
        </ul>
      </article>
      <article class="card">
        <h3 class="title">Average Txn</h3>
        <p class="value">₱{{ avg_transaction|floatformat:2 }}</p>
        <p class="meta">per entry</p>
      </article>
      <article class="card">
        <h3 class="title">Projected Month-End Balance</h3>
        <p class="value {% if projected_balance < 0 %}text-red-600{% else %}text-green-600{% endif %}">
          ₱{{ projected_balance|floatformat:2 }}
        </p>
        <p class="meta">based on avg ₱{{ avg_daily_spent|floatformat:2 }}/day</p>
      </article>
    </section>
    
    <section id="charts" class="content" role="region" aria-label="Charts">
        <section class="progress" role="region" aria-label="Monthly Trend chart">
            <h2 class="text-lg mb-2">Monthly Trend</h2>
            <nav aria-label="Trend view toggles" class="flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0 mb-4">
              <button
                id="trendBarBtn"
                class="px-3 py-1 rounded bg-indigo-600 text-white focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-400"
              >
                Bar
              </button>
              <button
                id="trendLineBtn"
                class="px-3 py-1 rounded bg-gray-200 text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-gray-400"
              >
                Line
              </button>

            </nav>            
          <canvas id="trendChart" class="w-full h-56 md:h-48 lg:h-64"></canvas>
        </section>        
          <section id="budgetCard" class="progress" role="region" aria-label="Budget Utilization chart">
            <h2 id="budgetCardTitle" class="text-lg mb-2">Budget Utilization</h2>
            <nav aria-label="Budget view toggles" class="flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0 mb-4">
              <button id="showOverall" class="px-3 py-1 rounded bg-indigo-600 text-white focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-400">
                Overall
              </button>
              <button id="showByCategory" class="px-3 py-1 rounded bg-gray-200 text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-gray-400">
                By Category
              </button>
            </nav>
            <section id="overallNoData" class="p-4 text-center text-gray-500 hidden" role="status">
              No budget data to display.
            </section>
            <canvas id="budgetChart" class="hidden w-full h-56 md:h-48 lg:h-64" aria-label="Overall budget utilization chart"></canvas>
      
            <section id="catNoData" class="p-4 text-center text-gray-500 hidden" role="status">
              No category data to display.
            </section>
            <canvas id="catBudgetDonut" class="hidden h-56 md:h-48 lg:h-64" aria-label="By-category budget utilization chart"></canvas>
          </section>
    
          <section class="progress" role="region" aria-label="Category Breakdown">
            <h2 class="text-lg mb-2">Category Breakdown</h2>
            <canvas id="categoryChart" class="w-full h-56 md:h-48 lg:h-64" height="200" aria-label="Category breakdown chart"></canvas>
            {% if category_summary %}
              <button
                class="mt-4 px-3 py-1 rounded bg-gray-200 text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-400"
                onclick="document.getElementById('categoryTable').classList.toggle('hidden')"
                aria-expanded="false"
                aria-controls="categoryTable"
                id="toggleCategoryChartTable"
              >
                Toggle detailed numbers
              </button>
              <section id="categoryTable" class="hidden overflow-x-auto mt-2" role="region" aria-label="Category detailed table">
                <table class="table-fixed w-full">
                  <thead class="bg-gray-100">
                    <tr>
                      <th class="px-3 py-2 text-left">Category</th>
                      <th class="px-3 py-2 text-left">Income</th>
                      <th class="px-3 py-2 text-left">Expense</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in category_summary %}
                      <tr>
                        <td class="px-3 py-2">{{ row.name }}</td>
                        <td class="px-3 py-2 text-green-600">₱{{ row.income|floatformat:2 }}</td>
                        <td class="px-3 py-2 text-red-600">₱{{ row.expense|floatformat:2 }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </section>
            {% else %}
              <p class="mt-3 text-center text-gray-500">No categories to display.</p>
            {% endif %}


          </section>
          <section class="progress mt-6" aria-label="Monthly Heatmap">
            <h2 class="text-lg mb-2">Entries This Month</h2>
            <canvas id="heatmapChart" class="w-full h-64"></canvas>
          </section>
          
    </section>
    {% with section_id="recent" aria_label="Recent Transactions table" table_id="dashboardTable" entries=recent_transactions empty_message="No transactions yet." title="Recent Transactions (latest 10 entries)" title_id="recent-heading" page_obj=page_obj_recent page_param="recent_page" %}
      {% include "main/components/tables/recent_transactions_table.html" %}
    {% endwith %}
</section>

{% block more_extra_scripts %}
  <script>
      document.addEventListener('DOMContentLoaded', function() {
      const ctxTrend = document.getElementById('trendChart').getContext('2d');
      const trendChart = new Chart(ctxTrend, {
        type: 'bar',                
        data: { 
          labels: {{ chart_trend_labels|safe }},
          datasets: [{
            label: 'Income',
            data: {{ chart_trend_income|safe }},
            backgroundColor: 'rgba(16,185,129,0.5)',
          },{
            label: 'Expenses',
            data: {{ chart_trend_expense|safe }},
            backgroundColor: 'rgba(239,68,68,0.5)',
          }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
      
      document.getElementById('trendBarBtn').addEventListener('click', () => {
        trendChart.config.type = 'bar';
        trendChart.update();
        document.getElementById('trendBarBtn').classList.replace('bg-gray-200','bg-indigo-600');
        document.getElementById('trendBarBtn').classList.replace('text-gray-700', 'text-white');
        document.getElementById('trendLineBtn').classList.replace('bg-indigo-600','bg-gray-200');
        document.getElementById('trendLineBtn').classList.replace('text-white', 'text-gray-700');
      });
    
      document.getElementById('trendLineBtn').addEventListener('click', () => {
        trendChart.config.type = 'line';
        trendChart.update();
        document.getElementById('trendLineBtn').classList.replace('bg-gray-200','bg-indigo-600');
        document.getElementById('trendLineBtn').classList.replace('text-gray-700', 'text-white');
        document.getElementById('trendBarBtn').classList.replace('bg-indigo-600','bg-gray-200');
        document.getElementById('trendBarBtn').classList.replace('text-white', 'text-gray-700');
      });
      
      const toggleBtns = document.getElementById('toggleCategoryChartTable');
      toggleBtns.addEventListener('click', () => {
        if (toggleBtns.classList.contains('bg-gray-200')) {
          toggleBtns.classList.replace('bg-gray-200', 'bg-indigo-600');
          toggleBtns.classList.replace('text-gray-700', 'text-white');
          document.getElementById('categoryTable').classList.remove('hidden');
        } else {
          toggleBtns.classList.replace('bg-indigo-600', 'bg-gray-200');
          toggleBtns.classList.replace('text-white', 'text-gray-700');
          document.getElementById('categoryTable').classList.add('hidden');
        }
      });
      
      (() => {
        const data = {{ chart_budget_data|default:"[]"|safe }};
        const canvas = document.getElementById('budgetChart');
        const noData = document.getElementById('overallNoData');
        const hasData = Array.isArray(data) && data.length > 0 && !data.every(v => v === 0);
    
        canvas.classList.toggle('hidden', !hasData);
        noData.classList.toggle('hidden', hasData);
    
        if (hasData) {
          new Chart(
            document.getElementById('budgetChart').getContext('2d'),
            {
              type: 'polarArea',
              data: {
                labels: ['Spent','Remaining'],
                datasets: [{
                  data: {{ chart_budget_data|safe }},
                  backgroundColor: ['rgba(239,68,68,0.5)','rgba(16,185,129,0.5)'],
                }]
              },
              options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            }
          );
          
        }
      })();
      
      (() => {
        const labels = {{ chart_cat_labels|default:"[]"|safe }};
        const budg = {{ chart_cat_budget|default:"[]"|safe }};
        const spent = {{ chart_cat_expense|default:"[]"|safe }};
        const canvas = document.getElementById('catBudgetDonut');
        const noData = document.getElementById('catNoData');
        const hasData = labels.length > 0 && !(budg.every(v => v === 0) && spent.every(v => v === 0));
    
        canvas.classList.toggle('hidden', !hasData);
        noData.classList.toggle('hidden', hasData);
    
        if (hasData) {
          new Chart(canvas.getContext('2d'), {
            type: 'doughnut',
            data: { labels, datasets: [{ label: 'Budget', data: budg }, { label: 'Spent', data: spent }] },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
          });
        }
      })();
      
      {% if chart_cat_labels and chart_cat_expense and chart_cat_income %}
        new Chart(
          document.getElementById('categoryChart').getContext('2d'),
          {
            type: 'pie',
            data: {
              labels: {{ chart_cat_labels|safe }},
              datasets: [{
                data: {{ chart_cat_expense|safe }},     // show expense distribution
                backgroundColor: {{ chart_cat_colors|safe }}, 
              }]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
          }
        );
      {% endif %}

      const ctxHM = document.getElementById('heatmapChart').getContext('2d');
new Chart(ctxHM, {
  type: 'matrix',
  data: {
    datasets: [{
      label: 'Entries',
      data: {{ heatmap_data|safe }},
      borderWidth: 1,
      borderColor: 'rgba(0,0,0,0.05)',
      backgroundColor: ({dataset, dataIndex}) => {
        const v   = dataset.data[dataIndex].v;
        const max = Math.max(...dataset.data.map(d=>d.v), 1);
        // 5-step GitHub ramp
        const level  = Math.min(5, Math.floor((v/max)*5));
        const alphas = [0,0.2,0.4,0.6,0.8,1];
        return `rgba(16,185,129,${alphas[level]})`;
      },
      width: ({chart}) => {
        const area = chart.chartArea;
        return area
          ? (area.width  / {{ heatmap_labels_x|length }}) - 2
          : 0;
      },
      height: ({chart}) => {
        const area = chart.chartArea;
        return area
          ? (area.height / {{ heatmap_labels_y|length }}) - 2
          : 0;
      }
    }]
  },
  options: {
    scales: {
      x: {
        type: 'category',
        labels: {{ heatmap_labels_x|safe }},
        grid: { display: false },
        offset: true
      },
      y: {
        type: 'category',
        labels: {{ heatmap_labels_y|safe }},
        grid: { display: false },
        offset: true
      }
    },
    plugins: {
      tooltip: {
        filter: ti => !!ti.raw.date,  // skip blanks & future
        callbacks: {
          title: ([item]) => item.raw.date,
          label: ctx => {
            const v = ctx.raw.v;
            return v
              ? `${v} entr${v===1?'y':'ies'}`
              : 'No entries';
          }
        }
      },
      legend: { display: false }
    }
  }
});




    });

    const btnOverall = document.getElementById('showOverall');
    const btnByCat = document.getElementById('showByCategory');
    const chartOverall = document.getElementById('budgetChart');
    const chartByCat = document.getElementById('catBudgetDonut');
    const noOverall = document.getElementById('overallNoData');
    const noByCat = document.getElementById('catNoData');
  
    function activateOverall() {
      btnOverall.classList.replace('bg-gray-200', 'bg-indigo-600');
      btnOverall.classList.replace('text-gray-700', 'text-white');
      btnByCat.classList.replace('bg-indigo-600', 'bg-gray-200');
      btnByCat.classList.replace('text-white', 'text-gray-700');
      chartOverall.hidden = false;
      chartByCat.hidden = true;
      noByCat.classList.add('hidden');
      noOverall.classList.toggle('hidden', !chartOverall.classList.contains('hidden'));
    }
  
    function activateByCategory() {
      btnByCat.classList.replace('bg-gray-200', 'bg-indigo-600');
      btnByCat.classList.replace('text-gray-700', 'text-white');
      btnOverall.classList.replace('bg-indigo-600', 'bg-gray-200');
      btnOverall.classList.replace('text-white', 'text-gray-700');
      noOverall.classList.add('hidden');
      noByCat.classList.toggle('hidden', !chartByCat.classList.contains('hidden'));
      chartOverall.hidden = true;
      chartByCat.hidden = false;
    }
  
    btnOverall.addEventListener('click', activateOverall);
    btnByCat.addEventListener('click', activateByCategory);
  
    activateOverall();    
  </script>
{% endblock %}