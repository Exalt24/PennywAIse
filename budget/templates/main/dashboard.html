{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block header %}{% endblock %}

{% block content %}
  <div class="flex h-screen overflow-hidden bg-[#f5f1ed] text-[#333]">
    
    {% include "main/sidebar.html" %}

    <main class="main">
    
      {% include "main/subheader.html" %}

      {% include "main/sections/dashboard.html" %}
      
      {% include "main/sections/categories.html" %}

      {% include "main/sections/income.html" %}

      {% include "main/sections/expenses.html" %}
        
      {% include "main/sections/budget.html" %}
        
      {% include "main/sections/reports.html" %}

      {% include "main/modals.html" %}

    </main>
  </div>

{%endblock%}

{% block footer %}{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
<script>
document.addEventListener('DOMContentLoaded', () => {
  // ---- Sidebar tab switching ----
  const links = Array.from(document.querySelectorAll('aside.sidebar nav a'));
  const pages = Array.from(document.querySelectorAll('.page-content'));

  function showTab(tabId) {
    links.forEach(link => {
      link.classList.toggle('active', link.getAttribute('href') === `#${tabId}`);
    });
    pages.forEach(page => {
      page.classList.toggle('hidden', page.id !== tabId);
    });
  }

  links.forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      const target = link.getAttribute('href').slice(1) || 'dashboard';
      showTab(target);
      document.querySelectorAll('.non-field-error').forEach(el => el.remove());
      const newHash = target !== 'dashboard' ? `#${target}` : '';
      history.replaceState(null, '', window.location.pathname + newHash);
    });
  });

  {% if active_tab != 'dashboard' %}
    showTab('{{ active_tab }}');
    history.replaceState(null, '', window.location.pathname + '#{{ active_tab }}');
  {% else %}
    const hash = window.location.hash.slice(1);
    const valid = pages.map(p => p.id);
    if (hash && valid.includes(hash)) {
      showTab(hash);
    } else {
      showTab('dashboard');
      history.replaceState(null, '', window.location.pathname);
    }
  {% endif %}

  // ---- User menu toggle ----
  const userBtn = document.getElementById('userBtn');
  const userMenu = document.getElementById('userMenu');
  userBtn.addEventListener('click', e => {
    e.stopPropagation();
    userMenu.classList.toggle('hidden');
  });
  document.addEventListener('click', () => userMenu.classList.add('hidden'));

  // ---- Modal controls ----
  const addEntryBtn = document.getElementById('addEntryBtn');
  const addEntryModal = document.getElementById('addEntryModal');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const cancelEntryBtn = document.getElementById('cancelEntryBtn');
  const modalTitle = document.getElementById('modalTitle');
  const modalSubmitBtn = document.getElementById('modalSubmitBtn');
  const modalTypeDiv = document.getElementById('modalTypeDiv');
  const form = document.querySelector('#addEntryModal form');

  function showModal() {
    addEntryModal.classList.remove('hidden');
    addEntryModal.classList.add('flex');
  }

  function hideModal() {
    addEntryModal.classList.add('hidden');
    addEntryModal.classList.remove('flex');
  }

  function cleanUrl() {
    history.replaceState(null, '', window.location.pathname + '');
  }

  function resetModalToAdd() {
    modalTitle.textContent = 'Add New Entry';
    modalSubmitBtn.textContent = 'Save';
    modalTypeDiv.classList.remove('hidden');
    const eid = document.getElementById('modalEntryId');
    if (eid) eid.value = '';
    form.querySelectorAll('input:not([type=hidden]), select, textarea').forEach(el => {
      el.value = '';
      if (el.tagName.toLowerCase() === 'select') el.selectedIndex = 0;
    });
    form.querySelectorAll('.text-red-600').forEach(e => e.remove());
  }

  addEntryBtn.addEventListener('click', e => {
    e.preventDefault();
    resetModalToAdd();
    showModal();
  });

  [closeModalBtn, cancelEntryBtn].forEach(btn => btn.addEventListener('click', e => {
    e.preventDefault();
    hideModal();
    cleanUrl();
    resetModalToAdd();
  }));

  addEntryModal.addEventListener('click', e => {
    if (e.target === addEntryModal) {
      hideModal();
      cleanUrl();
      resetModalToAdd();
    }
  });

  {% if is_edit or entry_form.errors %}
    showModal();
    cleanUrl();
  {% endif %}

  // ---- Table simple filtering ----
  function setupFilter(inputId, tableId) {
    const inp = document.getElementById(inputId);
    const tbl = document.getElementById(tableId);
    inp.addEventListener('input', () => {
      const q = inp.value.toLowerCase();
      tbl.querySelectorAll('tr').forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(q) ? '' : 'none';
      });
    });
  }

  // ---- Edit Category Modal ----
  const editCatModal = document.getElementById('editCategoryModal');
  const editCatIdInput = document.getElementById('editCategoryId');
  const closeEditCatModal = document.getElementById('closeEditCatModal');
  const editCatNameInput = editCatModal.querySelector('input[name="name"]');
  const cancelBtn = document.getElementById('cancelEditCategory');

  document.querySelectorAll('.edit-cat-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      editCatIdInput.value = btn.dataset.id;
      editCatNameInput.value = btn.dataset.name;
      editCatModal.classList.remove('hidden');
    });
  });

  cancelBtn.addEventListener('click', e => {
    e.preventDefault();
    editCatModal.classList.add('hidden');
    editCatIdInput.value = '';
    editCatNameInput.value = '';
    editCatModal.querySelectorAll('.text-red-600.mt-1').forEach(el => el.remove());
  });

  closeEditCatModal.addEventListener('click', e => {
    e.preventDefault();
    editCatModal.classList.add('hidden');
  });

  editCatModal.addEventListener('click', e => {
    if (e.target === editCatModal) {
      editCatModal.classList.add('hidden');
    }
  });

  {% if is_edit_category %}
    editCatModal.classList.remove('hidden');
  {% endif %}

  // ---- Table Advanced Filtering (Income, Expense Tables) ----
  function initTableFilter(opts) {
    const { dateFrom, dateTo, title, category, minAmt, maxAmt, tableBody } = opts;
    const df = document.querySelector(dateFrom);
    const dt = document.querySelector(dateTo);
    const ti = document.querySelector(title);
    const ca = document.querySelector(category);
    const mn = document.querySelector(minAmt);
    const mx = document.querySelector(maxAmt);
    const rows = Array.from(document.querySelectorAll(tableBody + ' tr'));
    const dateError = document.getElementById(dateFrom === '#incDateFrom' ? 'incDateError' : 'expDateError');
    const amtError = document.getElementById(minAmt === '#incMinAmount' ? 'incAmountError' : 'expAmountError');

    function applyFilters() {
      const fromDate = df.valueAsDate;
      const toDate = dt.valueAsDate;
      const titleQ = ti.value.trim().toLowerCase();
      const catQ = ca.value.trim().toLowerCase();
      const minA = parseFloat(mn.value) || -Infinity;
      const maxA = parseFloat(mx.value) || Infinity;

      let valid = true;
      if (fromDate && toDate && fromDate > toDate) {
        valid = false;
        dateError.classList.remove('hidden');
      } else {
        dateError.classList.add('hidden');
      }
      if (minA && maxA && minA > maxA) {
        valid = false;
        amtError.classList.remove('hidden');
      } else {
        amtError.classList.add('hidden');
      }

      if (!valid) return;

      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        let ok = true;

        if ((fromDate || toDate) && cells[3]) {
          const d = new Date(cells[3].textContent);
          if (fromDate && d < fromDate) ok = false;
          if (toDate && d > toDate) ok = false;
        }

        if (titleQ && cells[0] && !cells[0].textContent.toLowerCase().includes(titleQ)) ok = false;
        if (catQ && cells[1] && !cells[1].textContent.toLowerCase().includes(catQ)) ok = false;

        if (cells[2]) {
          const raw = cells[2].textContent.replace(/[^0-9.]/g, '');
          const amt = parseFloat(raw) || 0;
          if (amt < minA || amt > maxA) ok = false;
        }

        row.style.display = ok ? '' : 'none';
      });
    }

    [df, dt, ti, ca, mn, mx].forEach(el => el && el.addEventListener('input', applyFilters));
  }

  initTableFilter({
    dateFrom: '#incDateFrom',
    dateTo: '#incDateTo',
    title: '#incTitleFilter',
    category: '#incCategoryFilter',
    minAmt: '#incMinAmount',
    maxAmt: '#incMaxAmount',
    tableBody: '#incomeTable'
  });

  initTableFilter({
    dateFrom: '#expDateFrom',
    dateTo: '#expDateTo',
    title: '#expTitleFilter',
    category: '#expCategoryFilter',
    minAmt: '#expMinAmount',
    maxAmt: '#expMaxAmount',
    tableBody: '#expenseTable'
  });

  // ---- Charts ----
  {% if chart_trend_labels and chart_trend_income and chart_trend_expense %}
  new Chart(document.getElementById('trendChart').getContext('2d'), {
    type: 'line',
    data: {
      labels: {{ chart_trend_labels|safe }},
      datasets: [
        {
          label: 'Income',
          data: {{ chart_trend_income|safe }},
          borderColor: 'rgba(16,185,129,1)',
          fill: false
        },
        {
          label: 'Expenses',
          data: {{ chart_trend_expense|safe }},
          borderColor: 'rgba(239,68,68,1)',
          fill: false
        }
      ]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
  {% endif %}

  (() => {
    const data = {{ chart_budget_data|default:"[]"|safe }};
    const canvas = document.getElementById('budgetChart');
    const noData = document.getElementById('overallNoData');
    const hasData = Array.isArray(data) && data.length > 0 && !data.every(v => v === 0);

    canvas.classList.toggle('hidden', !hasData);
    noData.classList.toggle('hidden', hasData);

    if (hasData) {
      new Chart(canvas.getContext('2d'), {
        type: 'doughnut',
        data: { labels: ['Spent', 'Remaining'], datasets: [{ data }] },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
    }
  })();

  (() => {
    const labels = {{ chart_cat_labels|default:"[]"|safe }};
    const budg = {{ chart_cat_budget|default:"[]"|safe }};
    const spent = {{ chart_cat_expense|default:"[]"|safe }};
    const canvas = document.getElementById('catBudgetDonut');
    const noData = document.getElementById('catNoData');
    const hasData = labels.length > 0 && !(budg.every(v => v === 0) && spent.every(v => v === 0));

    canvas.classList.toggle('hidden', !hasData);
    noData.classList.toggle('hidden', hasData);

    if (hasData) {
      new Chart(canvas.getContext('2d'), {
        type: 'doughnut',
        data: { labels, datasets: [{ label: 'Budget', data: budg }, { label: 'Spent', data: spent }] },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
    }
  })();

  {% if chart_cat_labels and chart_cat_expense and chart_cat_income %}
  new Chart(document.getElementById('categoryChart').getContext('2d'), {
    type: 'bar',
    data: {
      labels: {{ chart_cat_labels|safe }},
      datasets: [
        {
          label: 'Expense',
          data: {{ chart_cat_expense|safe }},
          backgroundColor: 'rgba(239,68,68,0.5)'
        },
        {
          label: 'Income',
          data: {{ chart_cat_income|safe }},
          backgroundColor: 'rgba(16,185,129,0.5)'
        }
      ]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
  {% endif %}

  // ---- Sorting Tables ----
  document.querySelectorAll('th.sortable').forEach(th => {
    let asc = false;
    th.addEventListener('click', () => {
      const table = th.closest('table');
      const body = table.querySelector('tbody');
      const idx = Array.from(th.parentNode.children).indexOf(th);

      table.querySelectorAll('th.sortable').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));

      Array.from(body.querySelectorAll('tr')).sort((a, b) => {
        const aText = a.children[idx].textContent.trim();
        const bText = b.children[idx].textContent.trim();
        return asc
          ? aText.localeCompare(bText, undefined, { numeric: true })
          : bText.localeCompare(aText, undefined, { numeric: true });
      }).forEach(tr => body.appendChild(tr));

      th.classList.add(asc ? 'sort-asc' : 'sort-desc');
      asc = !asc;
    });
  });

  
  // ---- Report Table Filtering + Exporting ----

  const inputs = {
    from: document.getElementById('repFrom'),
    to: document.getElementById('repTo'),
    type: document.getElementById('repType'),
    cat: document.getElementById('repCat'),
  };
  const tableBody = document.querySelector('#reportTable tbody');

  function applyReportFilter() {
    const fromDate = inputs.from.valueAsDate;
    const toDate = inputs.to.valueAsDate;
    const typeVal = inputs.type.value;
    const catVal = inputs.cat.value;

    const isFilterActive = !!(fromDate || toDate || typeVal || catVal);
    document.getElementById('filterApplied').value = isFilterActive;

    Array.from(tableBody.querySelectorAll('tr')).forEach(row => {
      const cells = row.children;
      if (!cells.length) return;
      let show = true;
      const d = new Date(cells[0].textContent);
      if (fromDate && d < fromDate) show = false;
      if (toDate && d > toDate) show = false;
      if (typeVal && cells[3].textContent.trim() !== (typeVal === 'IN' ? 'Income' : 'Expense')) show = false;
      if (catVal && cells[2].dataset.catId !== catVal) show = false;
      row.style.display = show ? '' : 'none';
    });
  }

  Object.values(inputs).forEach(inp => inp.addEventListener('input', applyReportFilter));
  applyReportFilter();

  document.getElementById('exportCsv').addEventListener('click', () => {
    const isFiltered = document.getElementById('filterApplied').value === 'true';
  
    const tableToExport = isFiltered 
      ? document.querySelector('#reportTable') 
      : document.querySelector('#fullReportTable');
    
    const headers = Array.from(tableToExport.querySelectorAll('thead th')).map(th => th.textContent.trim());
    const rows = Array.from(tableToExport.querySelectorAll('tbody tr'))
      .filter(r => isFiltered ? r.style.display !== 'none' : true)
      .map(r => {
        return Array.from(r.children).map((td, idx) => {
          let cell = td.textContent.trim();
          if (idx === 2) cell = cell.replace(/[^\d\.-]/g, ''); // Adjusted index for amount column
          return cell;
        });
      });
    let csv = [headers, ...rows].map(r => r.map(cell => `"${cell.replace(/"/g, '""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'report.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  // ---- Overall vs By Category Chart Buttons ----
  const btnOverall = document.getElementById('showOverall');
  const btnByCat = document.getElementById('showByCategory');
  const chartOverall = document.getElementById('budgetChart');
  const chartByCat = document.getElementById('catBudgetDonut');
  const noOverall = document.getElementById('overallNoData');
  const noByCat = document.getElementById('catNoData');

  function activateOverall() {
    btnOverall.classList.replace('bg-gray-200', 'bg-indigo-600');
    btnOverall.classList.replace('text-gray-700', 'text-white');
    btnByCat.classList.replace('bg-indigo-600', 'bg-gray-200');
    btnByCat.classList.replace('text-white', 'text-gray-700');
    chartOverall.hidden = false;
    chartByCat.hidden = true;
    noByCat.classList.add('hidden');
    noOverall.classList.toggle('hidden', !chartOverall.classList.contains('hidden'));
  }

  function activateByCategory() {
    btnByCat.classList.replace('bg-gray-200', 'bg-indigo-600');
    btnByCat.classList.replace('text-gray-700', 'text-white');
    btnOverall.classList.replace('bg-indigo-600', 'bg-gray-200');
    btnOverall.classList.replace('text-white', 'text-gray-700');
    noOverall.classList.add('hidden');
    noByCat.classList.toggle('hidden', !chartByCat.classList.contains('hidden'));
    chartOverall.hidden = true;
    chartByCat.hidden = false;
  }

  btnOverall.addEventListener('click', activateOverall);
  btnByCat.addEventListener('click', activateByCategory);

  activateOverall(); // Default
});
</script>
{% endblock %}